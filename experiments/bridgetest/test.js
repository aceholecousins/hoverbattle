!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=51)}({51:function(e,t,n){"use strict";n.r(t);const r="undefined"!=typeof window&&"document"in window,o=!r,i=o?"worker":"window";function c(...e){0}function s(e,t){c(JSON.stringify("function"==typeof t?t():t));let n={};function r(){return"function"==typeof t&&(c(e.remoteOtherIndexCounter,JSON.stringify(t())),e.enqueueMsg({kind:"link",path:t()}),t=e.remoteOtherIndexCounter--),t}function o(){e.enqueueMsg({kind:"del",id:r()}),t=void 0}return new Proxy(Object,{set:(t,n,o)=>(e.enqueueMsg({kind:"set",id:r(),prop:n,val:u(e,o)}),!0),get(i,c,u){if("then"!==c)return"__ref__"===c?r():"dispose"===c?o:(c in n||(n[c]=s(e,function(e,t){return function(){return"function"==typeof e?[...e(),t]:[e,t]}}(t,c))),n[c])},apply:(t,n,o)=>(e.enqueueMsg({kind:"call",id:r(),args:u(e,o)}),c(r(),e.remoteOtherIndexCounter),s(e,e.remoteOtherIndexCounter--)),construct:(t,n)=>(e.enqueueMsg({kind:"new",id:r(),args:u(e,n)}),c(r(),e.remoteOtherIndexCounter),s(e,e.remoteOtherIndexCounter--))})}function u(e,t){switch(typeof t){case"number":case"string":case"boolean":return t;case"object":return function(e,t){let n=Array.isArray(t)?[]:{};for(let r in t){let o=u(e,t[r]);"object"==typeof o&&("__cb__"in o&&(n.__cb__=!0),"__ref__"in o&&(n.__ref__=!0)),n[r]=o}return n}(e,t);case"function":return void 0===t.__ref__?function(e,t){if(void 0===t.__cb__){c(e.localOwnIndexCounter),c();let n=e.localOwnIndexCounter++;return t.__cb__=n,e.localRegistry[n]=t,{__cb__:"new"}}return{__cb__:t.__cb__}}(e,t):{__ref__:t.__ref__}}throw new Error("unsendable type: "+typeof t)}function f(e,t){switch(typeof t){case"number":case"string":case"boolean":return t;case"object":return function(e,t){if("__cb__"in t){if("number"==typeof t.__cb__)return s(e,t.__cb__);if("new"===t.__cb__)return c(e.remoteOwnIndexCounter),s(e,e.remoteOwnIndexCounter++);if(!0===t.__cb__){for(let n in t)t[n]=f(e,t[n]);return t}throw new Error("unexpected callback reference type")}if("__ref__"in t){if("number"==typeof t.__ref__||"string"==typeof t.__ref__)return e.localRegistry[t.__ref__];if(!0===t.__ref__){for(let n in t)t[n]=f(e,t[n]);return t}throw new Error("unexpected reference type")}return t}(e,t)}}function l(e,t){switch(t.kind){case"ready":!function(e){e.connected=!0,e.sendWhenConnected&&e.sendAll()}(e);break;case"reg":!function(e,t){if(e.remoteRegistry.add(t.id),t.id in e.pendingProxies)for(let n of e.pendingProxies[t.id])n()}(e,t);break;case"link":!function(e,t){let n=e.localRegistry;for(let e of t.path){let t=n[e];"function"==typeof t&&(t=t.bind(n)),n=t}if("object"!=typeof n&&"function"!=typeof n)throw new Error("tried to link a field which is not an object or a method: "+t.path);0;e.localRegistry[e.localOtherIndexCounter--]=n}(e,t);break;case"call":!function(e,t){let n=e.localRegistry[t.id](...f(e,t.args));"object"==typeof n||"function"==typeof n?e.localRegistry[e.localOtherIndexCounter--]=n:(void 0!==n&&console.warn("result of remotely called function will be ignored"),e.localOtherIndexCounter--)}(e,t);break;case"new":!function(e,t){let n=new e.localRegistry[t.id](...f(e,t.args));0;e.localRegistry[e.localOtherIndexCounter--]=n}(e,t);break;case"set":!function(e,t){e.localRegistry[t.id][t.prop]=f(e,t.val)}(e,t);break;case"del":!function(e,t){void 0!==e.localRegistry[t.id].dispose&&e.localRegistry[t.id].dispose();delete e.localRegistry[t.id]}(e,t)}}var d=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function c(e){try{u(r.next(e))}catch(e){i(e)}}function s(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}u((r=r.apply(e,t||[])).next())}))};class a{constructor(e){this.worker=void 0,this.connected=!1,this.sendWhenConnected=!1,this.localRegistry={},this.remoteRegistry=new Set,this.pendingProxies={},this.localOwnIndexCounter=1,this.localOtherIndexCounter=-1,this.remoteOwnIndexCounter=1,this.remoteOtherIndexCounter=-1,this.msgQueue=[],void 0!==e?(this.worker=new Worker(e),this.worker.onmessage=this.receive.bind(this)):(onmessage=this.receive.bind(this),this.enqueueMsg({kind:"ready"}),this.sendAll(),this.connected=!0)}enqueueMsg(e){this.msgQueue.push(e)}sendAll(){if(0!=this.msgQueue.length){c();for(let e of this.msgQueue)c(JSON.stringify(e));void 0!==this.worker?this.connected?(this.worker.postMessage(this.msgQueue),this.msgQueue=[]):this.sendWhenConnected=!0:(postMessage(this.msgQueue),this.msgQueue=[])}}receive(e){for(let t in e.data){let n=e.data[t];c(),c(),l(this,n)}}register(e,t){c(),this.localRegistry[t]=e,this.enqueueMsg({kind:"reg",id:t})}createProxy(e){return d(this,void 0,void 0,(function*(){if(!isNaN(e))throw new Error("numeric indices are reserved for anonymous objects");if(e in this.remoteRegistry)return s(this,e);{let t=this;return new Promise((function(n){e in t.pendingProxies||(t.pendingProxies[e]=[]),t.pendingProxies[e].push((function(){n(s(t,e))}))}))}}))}}var _=function(e,t,n,r){return new(n||(n=Promise))((function(o,i){function c(e){try{u(r.next(e))}catch(e){i(e)}}function s(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(c,s)}u((r=r.apply(e,t||[])).next())}))};console.log("hi from "+i);let h=r?new a("./test.js"):new a;setInterval((function(){h.sendAll()}),100),o?function(){_(this,void 0,void 0,(function*(){let e={field:"hi",method(){console.log("method called")}};setTimeout((function(){h.register(e,"testObject")}),300)}))}():function(){_(this,void 0,void 0,(function*(){(yield h.createProxy("testObject")).method()}))}()}});
//# sourceMappingURL=test.js.map