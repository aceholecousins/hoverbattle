!function(e){var n={};function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}t.m=e,t.c=n,t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,n){if(1&n&&(e=t(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var o in e)t.d(r,o,function(n){return e[n]}.bind(null,o));return r},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},t.p="",t(t.s=51)}({51:function(e,n,t){"use strict";t.r(n);const r="undefined"!=typeof window&&"document"in window,o=!r,i=o?"worker":"window";function c(...e){0}function s(e,n){c(JSON.stringify("function"==typeof n?n():n));let t={};function r(){return"function"==typeof n&&(c(e.remoteOtherIndexCounter,JSON.stringify(n())),e.enqueueMsg({kind:"link",path:n()}),n=e.remoteOtherIndexCounter--),n}function o(){e.enqueueMsg({kind:"del",id:r()}),n=void 0}return new Proxy(Object,{set:(n,t,o)=>(e.enqueueMsg({kind:"set",id:r(),prop:t,val:u(e,o)}),!0),get(i,c,u){if("then"!==c)return"__ref__"===c?r():"dispose"===c?o:(c in t||(t[c]=s(e,function(e,n){return function(){return"function"==typeof e?[...e(),n]:[e,n]}}(n,c))),t[c])},apply:(n,t,o)=>(e.enqueueMsg({kind:"call",id:r(),args:u(e,o)}),c(r(),e.remoteOtherIndexCounter),s(e,e.remoteOtherIndexCounter--)),construct:(n,t)=>(e.enqueueMsg({kind:"new",id:r(),args:u(e,t)}),c(r(),e.remoteOtherIndexCounter),s(e,e.remoteOtherIndexCounter--))})}function u(e,n){switch(typeof n){case"undefined":case"number":case"string":case"boolean":return n;case"object":return function(e,n){let t=Array.isArray(n)?[]:{};for(let r in n){let o=u(e,n[r]);"object"==typeof o&&("__cb__"in o&&(t.__cb__=!0),"__ref__"in o&&(t.__ref__=!0)),t[r]=o}return t}(e,n);case"function":return void 0===n.__ref__?function(e,n){if(void 0===n.__cb__){c(e.localOwnIndexCounter),c();let t=e.localOwnIndexCounter++;return n.__cb__=t,e.localRegistry[t]=n,{__cb__:"new"}}return{__cb__:n.__cb__}}(e,n):{__ref__:n.__ref__}}throw new Error("unsendable type: "+typeof n)}function f(e,n){switch(typeof n){case"undefined":case"number":case"string":case"boolean":return n;case"object":return function(e,n){if("__cb__"in n){if("number"==typeof n.__cb__)return s(e,n.__cb__);if("new"===n.__cb__)return c(e.remoteOwnIndexCounter),s(e,e.remoteOwnIndexCounter++);if(!0===n.__cb__){for(let t in n)n[t]=f(e,n[t]);return n}throw new Error("unexpected callback reference type")}if("__ref__"in n){if("number"==typeof n.__ref__||"string"==typeof n.__ref__)return e.localRegistry[n.__ref__];if(!0===n.__ref__){for(let t in n)n[t]=f(e,n[t]);return n}throw new Error("unexpected reference type")}return n}(e,n)}}function l(e,n){switch(n.kind){case"ready":!function(e){e.connected=!0,e.sendWhenConnected&&e.sendAll()}(e);break;case"reg":!function(e,n){if(e.remoteRegistry.add(n.id),n.id in e.pendingProxies)for(let t of e.pendingProxies[n.id])t()}(e,n);break;case"link":!function(e,n){let t=e.localRegistry;for(let e of n.path){let n=t[e];"function"==typeof n&&(n=n.bind(t)),t=n}if("object"!=typeof t&&"function"!=typeof t)throw new Error("tried to link a field which is not an object or a method: "+n.path);0;e.localRegistry[e.localOtherIndexCounter--]=t}(e,n);break;case"call":!function(e,n){let t=e.localRegistry[n.id](...f(e,n.args));"object"==typeof t||"function"==typeof t?e.localRegistry[e.localOtherIndexCounter--]=t:(void 0!==t&&console.warn("result of remotely called function will be ignored"),e.localOtherIndexCounter--)}(e,n);break;case"new":!function(e,n){let t=new e.localRegistry[n.id](...f(e,n.args));0;e.localRegistry[e.localOtherIndexCounter--]=t}(e,n);break;case"set":!function(e,n){e.localRegistry[n.id][n.prop]=f(e,n.val)}(e,n);break;case"del":!function(e,n){void 0!==e.localRegistry[n.id].dispose&&e.localRegistry[n.id].dispose();delete e.localRegistry[n.id]}(e,n)}}var d=function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function c(e){try{u(r.next(e))}catch(e){i(e)}}function s(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}u((r=r.apply(e,n||[])).next())}))};class a{constructor(e){this.worker=void 0,this.connected=!1,this.sendWhenConnected=!1,this.localRegistry={},this.remoteRegistry=new Set,this.pendingProxies={},this.localOwnIndexCounter=1,this.localOtherIndexCounter=-1,this.remoteOwnIndexCounter=1,this.remoteOtherIndexCounter=-1,this.msgQueue=[],void 0!==e?(this.worker=new Worker(e),this.worker.onmessage=this.receive.bind(this)):(onmessage=this.receive.bind(this),this.enqueueMsg({kind:"ready"}),this.sendAll(),this.connected=!0)}enqueueMsg(e){this.msgQueue.push(e)}sendAll(){if(0!=this.msgQueue.length){c();for(let e of this.msgQueue)c(JSON.stringify(e));void 0!==this.worker?this.connected?(this.worker.postMessage(this.msgQueue),this.msgQueue=[]):this.sendWhenConnected=!0:(postMessage(this.msgQueue),this.msgQueue=[])}}receive(e){for(let n in e.data){let t=e.data[n];c(),c(),l(this,t)}}register(e,n){c(),this.localRegistry[n]=e,this.enqueueMsg({kind:"reg",id:n})}createProxy(e){return d(this,void 0,void 0,(function*(){if(!isNaN(e))throw new Error("numeric indices are reserved for anonymous objects");if(e in this.remoteRegistry)return s(this,e);{let n=this;return new Promise((function(t){e in n.pendingProxies||(n.pendingProxies[e]=[]),n.pendingProxies[e].push((function(){t(s(n,e))}))}))}}))}}var _=function(e,n,t,r){return new(t||(t=Promise))((function(o,i){function c(e){try{u(r.next(e))}catch(e){i(e)}}function s(e){try{u(r.throw(e))}catch(e){i(e)}}function u(e){var n;e.done?o(e.value):(n=e.value,n instanceof t?n:new t((function(e){e(n)}))).then(c,s)}u((r=r.apply(e,n||[])).next())}))};console.log("hi from "+i);let h=r?new a("./test.js"):new a;setInterval((function(){h.sendAll()}),100),o?function(){_(this,void 0,void 0,(function*(){let e={field:"hi",method(){console.log("method called")}};setTimeout((function(){h.register(e,"testObject")}),300)}))}():function(){_(this,void 0,void 0,(function*(){(yield h.createProxy("testObject")).method()}))}()}});
//# sourceMappingURL=test.js.map