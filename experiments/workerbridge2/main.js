!function(e){var o={};function t(r){if(o[r])return o[r].exports;var n=o[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.m=e,t.c=o,t.d=function(e,o,r){t.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:r})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,o){if(1&o&&(e=t(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(t.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var n in e)t.d(r,n,function(o){return e[o]}.bind(null,n));return r},t.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(o,"a",o),o},t.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},t.p="",t(t.s=23)}({23:function(e,o,t){"use strict";t.r(o);let r=new(t(7).a)("worker.js"),n={property:0,name:"Fred",body:{leg:{foot:{toe:{nail:"long"}}}},method(e,o,t){console.log("called myObj.method(",e,",",o,",",t,")")},callMeBack(e){setTimeout(()=>{console.log("----------------------------"),console.log("remote side inside callMeBack(cb):"),console.log('cb("ding")'),e("ding!"),r.sendAll(),console.log("----------------------------")},200)},useNestedCallback(e){setTimeout(()=>{console.log("----------------------------"),console.log("remote side inside useNestedCallback(arg):"),console.log('arg.child.cb("dong!")'),e.child.cb("dong!"),r.sendAll(),console.log("----------------------------")},400)},sayTheName(e){console.log("----------------------------"),console.log("remote side inside sayTheName(thing):"),console.log("console.log(thing.name)"),console.log(e.name),console.log("----------------------------")},dispose(){console.log("----------------------------"),console.log("remote side: dispose() called on myObj"),console.log("----------------------------")}};console.log("----------------------------"),console.log('remote side: bridge.register(myObj, "myObj")'),r.register(n,"myObj"),console.log('bridge.registry["myObj"] now points to myObj'),r.register(class{constructor(e,o){console.log("----------------------------"),console.log("remote side: new MyClass("+e+", "+o+")"),console.log("----------------------------")}toot(){console.log("toot")}},"MyClass"),console.log("----------------------------"),setTimeout((function(){console.log("myObj is now:"),console.log(JSON.stringify(n))}),1e3)},7:function(e,o,t){"use strict";t.d(o,"a",(function(){return r}));class r{constructor(e,o){this.worker=void 0,this.onReady=void 0,this.objectRegistry={},this.localIndexCounter=0,this.remoteIndexCounter=0,this.msgQueue=[],void 0!==e?(this.worker=new Worker(e),this.worker.onmessage=this.receive.bind(this),this.onReady=o):(onmessage=this.receive.bind(this),this.enqueueMsg({kind:"ready"}),this.sendAll())}enqueueMsg(e){this.msgQueue.push(e)}sendAll(){if(void 0!==this.worker){console.log("window -> worker:");for(let e of this.msgQueue)console.log("-> "+JSON.stringify(e));this.worker.postMessage(this.msgQueue)}else{console.log("worker -> window:");for(let e of this.msgQueue)console.log("-> "+JSON.stringify(e));postMessage(this.msgQueue)}this.msgQueue=[]}handleLinkage(e){let o=this.objectRegistry;for(let t of e.path)o=o[t];if("object"!=typeof o&&"function"!=typeof o)throw new Error("tried to link a field which is not an object or a method: "+e.path);this.objectRegistry[this.localIndexCounter++]=o}handleCall(e){let o=this.objectRegistry[e.id](...this.resolveReferences(e.args));"object"==typeof o||"function"==typeof o?this.objectRegistry[this.localIndexCounter++]=o:(void 0!==o&&console.warn("result of remotely called function will be ignored"),this.localIndexCounter++)}handleNew(e){let o=new this.objectRegistry[e.id](...this.resolveReferences(e.args));this.objectRegistry[this.localIndexCounter++]=o}handlePropertySet(e){this.objectRegistry[e.id][e.prop]=this.resolveReferences(e.val)}handleDispose(e){void 0!==this.objectRegistry[e.id].dispose&&this.objectRegistry[e.id].dispose(),delete this.objectRegistry[e.id]}receive(e){for(let o in e.data){let t=e.data[o];switch(t.kind){case"ready":void 0!==this.onReady&&this.onReady();break;case"link":this.handleLinkage(t);break;case"call":this.handleCall(t);break;case"new":this.handleNew(t);break;case"set":this.handlePropertySet(t);break;case"del":this.handleDispose(t)}}}register(e,o){this.objectRegistry[o]=e}createProxy(e){if(!isNaN(e))throw new Error("numeric indices are reserved for anonymous objects");return this._createProxy(e)}_createProxy(e){let o={},t=this;function r(){return"function"==typeof e&&(t.enqueueMsg({kind:"link",path:e()}),e=t.remoteIndexCounter++),e}function n(){t.enqueueMsg({kind:"del",id:r()}),e=void 0}return new Proxy(Object,{set:(e,o,n)=>(t.enqueueMsg({kind:"set",id:r(),prop:o,val:t.referencifyObject(n)}),!0),get:(s,i,c)=>"__ref__"===i?r():"dispose"===i?n:(i in o||(o[i]=t._createProxy(function(e,o){return function(){return"function"==typeof e?[...e(),o]:[e,o]}}(e,i))),o[i]),apply:(e,o,n)=>(t.enqueueMsg({kind:"call",id:r(),args:t.referencifyObject(n)}),t._createProxy(t.remoteIndexCounter++)),construct:(e,o)=>(t.enqueueMsg({kind:"new",id:r(),args:t.referencifyObject(o)}),t._createProxy(t.remoteIndexCounter++))})}referencifyFunction(e){if(void 0===e.__cb__){let o=this.localIndexCounter++;return e.__cb__=o,this.objectRegistry[o]=e,{__cb__:"new"}}return{__cb__:e.__cb__}}referencifyChildren(e){let o=Array.isArray(e)?[]:{};for(let t in e){let r=this.referencifyObject(e[t]);"object"==typeof r&&("__cb__"in r&&(o.__cb__=!0),"__ref__"in r&&(o.__ref__=!0)),o[t]=r}return o}referencifyObject(e){switch(typeof e){case"number":case"string":case"boolean":return e;case"object":return this.referencifyChildren(e);case"function":return void 0===e.__ref__?this.referencifyFunction(e):{__ref__:e.__ref__}}throw new Error("unsendable type: "+typeof e)}resolveReferenceMembers(e){if("__cb__"in e){if("number"==typeof e.__cb__)return this._createProxy(e.__cb__);if("new"===e.__cb__)return this._createProxy(this.remoteIndexCounter++);if(!0===e.__cb__){for(let o in e)e[o]=this.resolveReferences(e[o]);return e}throw new Error("unexpected callback reference type")}if("__ref__"in e){if("number"==typeof e.__ref__||"string"==typeof e.__ref__)return this.objectRegistry[e.__ref__];if(!0===e.__ref__){for(let o in e)e[o]=this.resolveReferences(e[o]);return e}throw new Error("unexpected reference type")}return e}resolveReferences(e){switch(typeof e){case"number":case"string":case"boolean":return e;case"object":return this.resolveReferenceMembers(e)}}}}});
//# sourceMappingURL=main.js.map