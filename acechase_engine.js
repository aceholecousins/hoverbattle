var window=self;importScripts("./acechase_lib.js"),function(e){function t(t){for(var s,r,a=t[0],c=t[1],u=t[2],h=0,d=[];h<a.length;h++)r=a[h],Object.prototype.hasOwnProperty.call(o,r)&&o[r]&&d.push(o[r][0]),o[r]=0;for(s in c)Object.prototype.hasOwnProperty.call(c,s)&&(e[s]=c[s]);for(l&&l(t);d.length;)d.shift()();return i.push.apply(i,u||[]),n()}function n(){for(var e,t=0;t<i.length;t++){for(var n=i[t],s=!0,a=1;a<n.length;a++){var c=n[a];0!==o[c]&&(s=!1)}s&&(i.splice(t--,1),e=r(r.s=n[0]))}return e}var s={},o={1:0},i=[];function r(t){if(s[t])return s[t].exports;var n=s[t]={i:t,l:!1,exports:{}};return e[t].call(n.exports,n,n.exports,r),n.l=!0,n.exports}r.m=e,r.c=s,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)r.d(n,s,function(t){return e[t]}.bind(null,s));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="";var a=window.webpackJsonp=window.webpackJsonp||[],c=a.push.bind(a);a.push=t,a=a.slice();for(var u=0;u<a.length;u++)t(a[u]);var l=c;i.push([73,0]),n()}({11:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var s=n(1),o=n(3);class i{constructor(e={}){this.position=s.d.fromValues(0,0,0),this.orientation=s.b.fromValues(0,0,0,1),this.scaling=s.d.fromValues(1,1,1),this.kind=e.kind,Object(o.b)(this,e,["position","orientation","scaling"])}}},15:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var s=n(11),o=n(3);class i extends s.a{constructor(e={}){super(e),this.kind="camera",this.nearClip=.1,this.farClip=1e3,this.verticalAngleOfViewInDeg=40,this.onAspectChange=function(e){},Object(o.b)(this,e,["nearClip","farClip","verticalAngleOfViewInDeg"])}}},3:function(e,t,n){"use strict";function s(e,t,n){for(const s of n)e[s]=t[s]}function o(e,t,n){for(const s of n)s in t&&(e[s]=t[s])}n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}))},5:function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));function s(...e){0}function o(e,t){s(JSON.stringify("function"==typeof t?t():t));let n={};function r(){return"function"==typeof t&&(s(e.remoteOtherIndexCounter,JSON.stringify(t())),e.enqueueMsg({kind:"link",path:t()}),t=e.remoteOtherIndexCounter--),t}function a(){e.enqueueMsg({kind:"del",id:r()}),t=void 0}return new Proxy(Object,{set:(t,n,s)=>(e.enqueueMsg({kind:"set",id:r(),prop:n,val:i(e,s)}),!0),get(s,i,c){if("then"!==i)return"__ref__"===i?r():"dispose"===i?a:(i in n||(n[i]=o(e,function(e,t){return function(){return"function"==typeof e?[...e(),t]:[e,t]}}(t,i))),n[i])},apply:(t,n,a)=>(e.enqueueMsg({kind:"call",id:r(),args:i(e,a)}),s(r(),e.remoteOtherIndexCounter),o(e,e.remoteOtherIndexCounter--)),construct:(t,n)=>(e.enqueueMsg({kind:"new",id:r(),args:i(e,n)}),s(r(),e.remoteOtherIndexCounter),o(e,e.remoteOtherIndexCounter--))})}function i(e,t){switch(typeof t){case"undefined":case"number":case"string":case"boolean":return t;case"object":return function(e,t){let n=Array.isArray(t)?[]:{};for(let s in t){let o=i(e,t[s]);"object"==typeof o&&("__cb__"in o&&(n.__cb__=!0),"__ref__"in o&&(n.__ref__=!0)),n[s]=o}return n}(e,t);case"function":return void 0===t.__ref__?function(e,t){if(void 0===t.__cb__){s(e.localOwnIndexCounter),s();let n=e.localOwnIndexCounter++;return t.__cb__=n,e.localRegistry[n]=t,{__cb__:"new"}}return{__cb__:t.__cb__}}(e,t):{__ref__:t.__ref__}}throw new Error("unsendable type: "+typeof t)}function r(e,t){switch(typeof t){case"undefined":case"number":case"string":case"boolean":return t;case"object":return function(e,t){if("__cb__"in t){if("number"==typeof t.__cb__)return o(e,t.__cb__);if("new"===t.__cb__)return s(e.remoteOwnIndexCounter),o(e,e.remoteOwnIndexCounter++);if(!0===t.__cb__){for(let n in t)t[n]=r(e,t[n]);return t}throw new Error("unexpected callback reference type")}if("__ref__"in t){if("number"==typeof t.__ref__||"string"==typeof t.__ref__)return e.localRegistry[t.__ref__];if(!0===t.__ref__){for(let n in t)t[n]=r(e,t[n]);return t}throw new Error("unexpected reference type")}return t}(e,t)}}function a(e,t){switch(t.kind){case"ready":!function(e){e.connected=!0,e.sendWhenConnected&&e.sendAll()}(e);break;case"reg":!function(e,t){if(e.remoteRegistry.add(t.id),t.id in e.pendingProxies)for(let n of e.pendingProxies[t.id])n()}(e,t);break;case"link":!function(e,t){let n=e.localRegistry;for(let e of t.path){let t=n[e];"function"==typeof t&&(t=t.bind(n)),n=t}if("object"!=typeof n&&"function"!=typeof n)throw new Error("tried to link a field which is not an object or a method: "+t.path);0;e.localRegistry[e.localOtherIndexCounter--]=n}(e,t);break;case"call":!function(e,t){let n=e.localRegistry[t.id](...r(e,t.args));"object"==typeof n||"function"==typeof n?e.localRegistry[e.localOtherIndexCounter--]=n:(void 0!==n&&console.warn("result of remotely called function will be ignored"),e.localOtherIndexCounter--)}(e,t);break;case"new":!function(e,t){let n=new e.localRegistry[t.id](...r(e,t.args));0;e.localRegistry[e.localOtherIndexCounter--]=n}(e,t);break;case"set":!function(e,t){e.localRegistry[t.id][t.prop]=r(e,t.val)}(e,t);break;case"del":!function(e,t){void 0!==e.localRegistry[t.id].dispose&&e.localRegistry[t.id].dispose();delete e.localRegistry[t.id]}(e,t)}}var c=function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};class u{constructor(e){this.worker=void 0,this.connected=!1,this.sendWhenConnected=!1,this.localRegistry={},this.remoteRegistry=new Set,this.pendingProxies={},this.localOwnIndexCounter=1,this.localOtherIndexCounter=-1,this.remoteOwnIndexCounter=1,this.remoteOtherIndexCounter=-1,this.msgQueue=[],void 0!==e?(this.worker=new Worker(e),this.worker.onmessage=this.receive.bind(this)):(onmessage=this.receive.bind(this),this.enqueueMsg({kind:"ready"}),this.sendAll(),this.connected=!0)}enqueueMsg(e){this.msgQueue.push(e)}sendAll(){if(0!=this.msgQueue.length){s();for(let e of this.msgQueue)s(JSON.stringify(e));void 0!==this.worker?this.connected?(this.worker.postMessage(this.msgQueue),this.msgQueue=[]):this.sendWhenConnected=!0:(postMessage(this.msgQueue),this.msgQueue=[])}}receive(e){for(let t in e.data){let n=e.data[t];s(),s(),a(this,n)}}register(e,t){s(),this.localRegistry[t]=e,this.enqueueMsg({kind:"reg",id:t})}createProxy(e){return c(this,void 0,void 0,(function*(){if(!isNaN(e))throw new Error("numeric indices are reserved for anonymous objects");if(e in this.remoteRegistry)return o(this,e);{let t=this;return new Promise((function(n){e in t.pendingProxies||(t.pendingProxies[e]=[]),t.pendingProxies[e].push((function(){n(o(t,e))}))}))}}))}}let l;void 0!==window.document?(console.log("loading engine"),l=new u("./acechase_engine.js")):l=new u},73:function(e,t,n){"use strict";n.r(t);var s=n(5),o=function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};var i=n(3),r=n(11);class a extends r.a{constructor(e={}){super(e),this.kind="mesh",Object(i.b)(this,e,["baseColor","accentColor"])}}class c extends a{constructor(e){super(e),this.asset=e.asset}}class u{constructor(e,t){this.note=t,this.check=e}}var l=n(6),h=n(1);class d{updateP2(){this.p2shape.updateBoundingRadius(),null!==this.p2shape.body&&(this.p2shape.body.aabbNeedsUpdate=!0,this.p2shape.body.updateBoundingRadius())}set offset(e){h.c.copy(this.p2shape.position,e)}get offset(){return h.c.clone(this.p2shape.position)}set offsetAngle(e){this.p2shape.angle=e}get offsetAngle(){return this.p2shape.angle}}const p=new class{constructor(){this.constructors={}}register(e,t){this.constructors[e]=t}createShape(e){if(!this.constructors.hasOwnProperty(e.kind))throw new Error("P2ShapeFactory cannot create a "+e.kind);return new this.constructors[e.kind](e)}};class f{constructor(e,t){this.toBeDeleted=!1,this.p2world=e,this.p2body=new l.Body,Object.assign(this,t);for(let e of t.shapes){let t=p.createShape(e);this.p2body.addShape(t.p2shape)}this.p2world.addBody(this.p2body)}set mass(e){e===1/0?this.p2body.type=l.Body.STATIC:(this.p2body.type=l.Body.DYNAMIC,this.p2body.mass=e),this.p2body.updateMassProperties()}get mass(){return this.p2body.type===l.Body.STATIC?1/0:this.p2body.mass}set position(e){h.c.copy(this.p2body.position,e)}get position(){return h.c.clone(this.p2body.position)}set velocity(e){h.c.copy(this.p2body.velocity,e)}get velocity(){return h.c.clone(this.p2body.velocity)}set damping(e){this.p2body.damping=e}get damping(){return this.p2body.damping}set angle(e){this.p2body.angle=e}get angle(){return this.p2body.angle}set angularVelocity(e){this.p2body.angularVelocity=e}get angularVelocity(){return this.p2body.angularVelocity}set angularDamping(e){this.p2body.angularDamping=e}get angularDamping(){return this.p2body.angularDamping}applyForce(e,t=h.c.fromValues(0,0)){this.p2body.applyForce([e[0],e[1]],[t[0],t[1]])}applyLocalForce(e,t=h.c.fromValues(0,0)){this.p2body.applyForceLocal([e[0],e[1]],[t[0],t[1]])}applyImpulse(e,t=h.c.fromValues(0,0)){this.p2body.applyImpulse([e[0],e[1]],[t[0],t[1]])}applyLocalImpulse(e,t=h.c.fromValues(0,0)){this.p2body.applyImpulseLocal([e[0],e[1]],[t[0],t[1]])}applyTorque(e){this.p2body.angularForce+=e}applyAngularMomentum(e){this.p2body.angularVelocity+=this.p2body.invInertia*e}remove(){this.p2world.removeBody(this.p2body)}}p.register("circle",class extends d{constructor(e){super(),this.p2shape=new l.Circle,Object.assign(this,e)}set radius(e){this.p2shape.radius=e,this.updateP2()}get radius(){return this.p2shape.radius}set boundingRadius(e){this.p2shape.radius=e,this.updateP2()}get boundingRadius(){return this.p2shape.boundingRadius}});p.register("triangle",class extends d{constructor(e){super();let t=l.Convex.triangleArea(e.corners[0],e.corners[1],e.corners[2]);Math.abs(t)<1e-100?(this.p2shape=new l.Convex,console.error("degenerate triangle")):this.p2shape=t>0?new l.Convex({vertices:e.corners}):new l.Convex({vertices:[e.corners[0],e.corners[2],e.corners[1]]}),Object.assign(this,e)}set corners(e){this.p2shape.vertices=e,this.updateP2()}get corners(){return this.p2shape.vertices}set boundingRadius(e){if(e<=0)return void console.error("triangle bounding radius must be >0");let t=e/this.p2shape.boundingRadius;for(let e of this.p2shape.vertices)e[0]*=t,e[1]*=t;this.updateP2()}get boundingRadius(){return this.p2shape.boundingRadius}});class g extends class{constructor(e){this.offset=h.c.fromValues(0,0),this.offsetAngle=0,this.kind=e.kind,Object(i.b)(this,e,["offset","offsetAngle"])}}{constructor(e={}){super(e),this.kind="circle",this.radius=1,Object(i.b)(this,e,["radius"])}}class y{constructor(e){this.mass=1,this.position=h.c.fromValues(0,0),this.velocity=h.c.fromValues(0,0),this.damping=.1,this.angle=0,this.angularVelocity=0,this.angularDamping=.1,Object(i.b)(this,e,["shapes","mass","position","velocity","damping","angle","angularVelocity","angularDamping"])}}function b(e,t=Math.PI){let n=(e-t)/2/Math.PI;return 2*(n-Math.floor(n)-1)*Math.PI+t}let m={};function w(e,t,n,s){!function(e,t,n,s){if(e in m){let s=m[e](t);n(s)}else{var o=new XMLHttpRequest;o.addEventListener("load",(function(){let s=this.responseText,o=new Function("{"+Object.keys(t).join()+"}",s);m[e]=o;let i=o(t);n(i)})),void 0!==s&&(o.addEventListener("error",s),o.addEventListener("abort",s)),o.open("GET",e),o.send()}}(e,{graphics:t,physics:n},s)}var _=n(15);class v extends _.a{constructor(e={}){super(e),this.dMin=5,this.marginFactor=1.33,this.tau={xy:1,up:.3,down:2,focus:.3},this.tauFocus=.1,Object(i.b)(this,e,["dMin","tau","tauFocus","marginFactor"])}}class x{constructor(e,t){this.distanceOverWidth=1,this.distanceOverHeight=1,this.locks=new Set,this.camera=e.camera.create(t),this.distanceOverHeight=.5/Math.tan(.5*t.verticalAngleOfViewInDeg/180*Math.PI)*t.marginFactor;let n=this;this.camera.onAspectChange=function(e){n.distanceOverWidth=n.distanceOverHeight/e},this.dMin=t.dMin,this.tau=t.tau,this.currentPosition=t.position,this.currentFocus=h.d.fromValues(0,0,0)}follow(e,t){this.locks.add({body:e,radius:t})}unfollow(e){for(let t of this.locks)t.body===e&&this.locks.delete(t)}update(e){let t=1e12,n=-1e12,s=1e12,o=-1e12;for(let e of this.locks)t=Math.min(t,e.body.position[0]-e.radius),n=Math.max(n,e.body.position[0]+e.radius),s=Math.min(s,e.body.position[1]-e.radius),o=Math.max(o,e.body.position[1]+e.radius);let i=h.d.fromValues((t+n)/2,(s+o)/2,Math.max((n-t)*this.distanceOverWidth,(o-s)*this.distanceOverHeight,this.dMin)),r=Math.exp(-e/this.tau.xy),a=this.currentPosition[2]<i[2]?this.tau.up:this.tau.down,c=Math.exp(-e/a),u=h.d.fromValues(r,r,c),l=Math.exp(-e/this.tau.focus);for(let e=0;e<3;e++)this.currentPosition[e]=(1-u[e])*i[e]+u[e]*this.currentPosition[e];this.currentFocus[0]=(1-l)*this.currentFocus[0]+l*i[0],this.currentFocus[1]=(1-l)*this.currentFocus[1]+l*i[1];let d=h.d.subtract(h.d.create(),this.currentPosition,this.currentFocus);h.d.normalize(d,d);let p=h.d.fromValues(0,1,0),f=h.d.cross(h.d.create(),p,d);h.d.normalize(f,f),h.d.cross(p,d,f);let g=function(e,t,n,s){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=n[0],e[4]=n[1],e[5]=n[2],e[6]=s[0],e[7]=s[1],e[8]=s[2],e}(h.a.create(),f,p,d);this.camera.position=this.currentPosition,this.camera.orientation=h.b.fromMat3(h.b.create(),g)}}class C{constructor(){this.thrust=0,this.shooting=!1}getAbsoluteDirection(){return this.absobulteDirection}getTurnRate(){return this.turnRate}getThrust(){return this.thrust}isShooting(){return this.shooting}setPauseCallback(e){throw new Error("Method not implemented.")}setAbsoluteDirection(e){this.absobulteDirection=e}setTurnRate(e){this.turnRate=e}setThrust(e){this.thrust=e}setShooting(e){this.shooting=e}}class k{constructor(){this.connectedControllers=new Set,this.connectionCallbacks=new Set}addConnectionCallback(e){this.connectionCallbacks.add(e);for(const t of this.connectedControllers)e(t)}removeConnectionCallback(e){this.connectionCallbacks.delete(e)}controllerAdded(e){const t=function(e){let t=new C;return s.a.register(t,e),t}(e);this.connectedControllers.add(t);for(const e of this.connectionCallbacks)e(t)}}var O=function(e,t,n,s){return new(n||(n=Promise))((function(o,i){function r(e){try{c(s.next(e))}catch(e){i(e)}}function a(e){try{c(s.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}c((s=s.apply(e,t||[])).next())}))};let M,I,P,R,j=new class{constructor(){this.p2world=new l.World({gravity:[0,0]})}addRigidBody(e){return new f(this.p2world,e)}step(e){this.p2world.step(e)}},A=new class{constructor({onItemCheck:e=(e=>{}),onComplete:t=(()=>{})}={}){this.items=new Set,this.numTotalItems=0,this.onItemCheck=e,this.onComplete=t}newItem({onCheck:e=(()=>{}),note:t}={}){this.numTotalItems++;let n=this,s=new u(()=>{e(),n.onItemCheck(s.note),n.items.delete(s),0==n.items.size&&n.onComplete()},t);return this.items.add(s),s}getProgress(){return 1-this.items.size/this.numTotalItems}reset(){this.items.clear(),this.numTotalItems=0}}({onComplete:function(){const e=new y({shapes:[new g({radius:1})],damping:.7,angularDamping:.99}),t=new c({asset:I});let n=[];F.addConnectionCallback(s=>{for(let o=0;o<10;o++){let o=new D(e,t,s);o.body.position=h.c.fromValues(20*Math.random()-10,20*Math.random()-10),o.body.angle=1e3*Math.random(),n.push(o),R.follow(o.body,1.5)}}),setInterval(()=>{for(let e of n)e.update();j.step(.01),R.update(.01),s.a.sendAll()},10)}}),S=A.newItem(),V=A.newItem(),T=A.newItem(),F=function(e){let t=new k;return s.a.register(t,e),t}("controllerManager");!function(){O(this,void 0,void 0,(function*(){M=yield function(){return o(this,void 0,void 0,(function*(){return s.a.createProxy("graphicsServer")}))}(),M.control.setSceneOrientation([-Math.SQRT1_2,0,0,Math.SQRT1_2]),S.check(),R=new x(M,new v),R.camera.activate(),I=M.model.load("glider/glider.gltf",V.check),w("arenas/testarena2/script.js",M,j,(function(e){P=e,T.check()})),s.a.sendAll()}))}();class D{constructor(e,t,n){this.thrust=0,this.body=j.addRigidBody(e),this.mesh=M.mesh.createFromModel(t),this.controller=n}update(){this.thrust=20*this.controller.getThrust(),this.body.applyLocalForce(h.c.fromValues(this.thrust,0));const e=this.controller.getTurnRate();null!=e&&this.body.applyTorque(20*e);const t=this.controller.getAbsoluteDirection();null!=t&&this.turnToDirection(t),this.mesh.position=[this.body.position[0],this.body.position[1],.1],this.mesh.orientation=h.b.fromEuler([0,0,0,0],0,0,this.body.angle/Math.PI*180)}turnToDirection(e){let t=b(this.body.angle),n=b(t-e);if(Math.abs(n)>1e-4){let e=Math.sign(n);this.body.applyAngularMomentum(.3*-e)}}}}});
//# sourceMappingURL=acechase_engine.js.map